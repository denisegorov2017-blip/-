# План разделения парсинга и преобразования в CSV формат

## Цель
Разделить процессы парсинга отчетов и преобразования данных в универсальный CSV формат для повышения гибкости, переиспользуемости и поддержки различных форматов отчетов.

## Архитектура

### 1. Модули парсинга (parsers)
Отдельные модули для каждого формата отчета:
- `pdf_parser.py` - для PDF отчетов
- `excel_parser.py` - для Excel отчетов (.xls, .xlsx)
- `csv_parser.py` - для CSV отчетов

Каждый модуль содержит функции для извлечения структурированных данных:
- `parse_report(file_path)` - основная функция парсинга
- Возвращает унифицированную структуру данных

### 2. Унифицированная структура данных
Стандартный формат для хранения извлеченных данных (реализован в `data_structure.py`):

```python
{
    "report_info": {
        "period_start": datetime,
        "period_end": datetime,
        "warehouse": str,
        "creation_date": datetime
    },
    "nomenclatures": [
        {
            "name": str,
            "initial_balance": float,
            "incoming": float,
            "outgoing": float,
            "final_balance": float,
            "documents": [
                {
                    "type": str,  # "Inventory", "Shipment", "Receipt", etc.
                    "date": datetime,
                    "details": {...}  # Специфические детали документа
                }
            ],
            "batches": [
                {
                    "date": datetime,
                    "initial_balance": float,
                    "incoming": float,
                    "outgoing": float,
                    "final_balance": float
                }
            ]
        }
    ]
}
```

### 3. Модуль преобразования (converter)
Модуль `data_converter.py` для преобразования унифицированной структуры в CSV:
- `to_csv(data_structure, output_path)` - сохраняет данные в CSV
- `from_csv(csv_path)` - загружает данные из CSV

### 4. Расчетные скрипты
Скрипты расчета (`improved_coefficient_calculator.py`, `preliminary_shrinkage_calculator.py`) работают с унифицированной структурой данных или с CSV-файлами, созданными конвертером.

## Текущее состояние разработки

### Реализовано

1.  **Созданы каркасы модулей**:
    - `data_structure.py` - определение и валидация унифицированной структуры данных
    - `data_converter.py` - преобразование данных в CSV и обратно
    - `pdf_parser.py` - каркас для парсинга PDF отчетов
    - `improved_coefficient_calculator_modern.py` - современная версия калькулятора коэффициентов

2.  **Созданы вспомогательные скрипты**:
    - `run_modern_calculator.bat` - запуск современной версии калькулятора
    - `run_demo_modular_architecture.bat` - демонстрация работы модульной архитектуры
    - `run_test_modular_architecture.bat` - тестирование модульной архитектуры

3.  **Обновлена документация**:
    - `project_index.md` - индекс проекта
    - `README.md` - основная документация
    - `MODERNIZATION_REPORT.md` - отчет о модернизации проекта

4.  **Реализована поддержка параметра `--calculation_start_date`**:
    - В `improved_coefficient_calculator.py` и `preliminary_shrinkage_calculator.py`
    - В `improved_coefficient_calculator_modern.py` и `demo_modular_architecture.py`
    - Позволяет извлекать начальные остатки на заданную дату, обеспечивая сравнимость результатов

### В разработке

1.  **Реализация PDF парсера** (`pdf_parser.py`):
    - Требуется реализация логики извлечения таблиц из PDF
    - Требуется реализация логики парсинга таблиц и извлечения данных о номенклатурах

2.  **Создание Excel парсера** (`excel_parser.py`):
    - Требуется создание модуля для парсинга Excel отчетов
    - Требуется реализация логики извлечения данных из Excel файлов

3.  **Создание CSV парсера** (`csv_parser.py`):
    - Требуется создание модуля для парсинга CSV отчетов
    - Требуется реализация логики извлечения данных из CSV файлов

4.  **Интеграция с расчетными скриптами**:
    - Требуется модификация расчетных скриптов для работы с новой архитектурой
    - Требуется обеспечение обратной совместимости

## Преимущества
- Унификация входных данных для всех расчетных скриптов
- Упрощение добавления поддержки новых форматов отчетов
- Повышение надежности и тестируемости каждого компонента
- Повышение переиспользуемости кода

## План дальнейшей разработки

### Этап 1: Завершение разработки парсеров
1.  **Реализация PDF парсера** (`pdf_parser.py`)
    - Реализовать логику извлечения таблиц из PDF
    - Реализовать логику парсинга таблиц и извлечения данных о номенклатурах
    - Протестировать работу парсера на реальных PDF отчетах

2.  **Создание Excel парсера** (`excel_parser.py`)
    - Создать модуль для парсинга Excel отчетов
    - Реализовать логику извлечения данных из Excel файлов
    - Протестировать работу парсера на реальных Excel отчетах

3.  **Создание CSV парсера** (`csv_parser.py`)
    - Создать модуль для парсинга CSV отчетов
    - Реализовать логику извлечения данных из CSV файлов
    - Протестировать работу парсера на реальных CSV отчетах

### Этап 2: Интеграция и тестирование
1.  **Интеграция парсеров с современным калькулятором** (`improved_coefficient_calculator_modern.py`)
    - Модифицировать калькулятор для работы с новыми парсерами
    - Обеспечить корректную обработку данных из разных форматов

2.  **Тестирование**
    - Протестировать работу всей системы с разными форматами отчетов
    - Сравнить результаты с классической версией калькулятора
    - Исправить выявленные ошибки и недочеты

### Этап 3: Документация и распространение
1.  **Обновление документации**
    - Обновить `README.md` с информацией о новых возможностях
    - Обновить `project_index.md` с описанием новых файлов
    - Создать примеры использования новых возможностей

2.  **Создание примеров**
    - Создать примеры использования системы с разными форматами отчетов
    - Создать руководство пользователя для новой архитектуры

3.  **Распространение**
    - Подготовить релиз новой версии системы
    - Обеспечить обратную совместимость с предыдущими версиями