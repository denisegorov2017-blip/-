
# Описание формата отчета и логики расчета усушки
**Версия:** 5.1 (финальная)
**Дата:** 04.08.2025

## 1. Общая структура отчета
Отчет имеет иерархическую структуру, предназначенную для анализа движения товаров с учетом партий.

**Иерархия:**
1.  **Группа товаров**
2.  **Товар**
3.  **Документ движения**
4.  **Партия**

---

## 2. Ключевые различия и поля

### 2.1. Группа товаров
- **Описание:** Строка-заголовок для широкой категории (например, "ВЯЛЕНАЯ РЫБА (весовой товар)").
- **Ключевой признак:** Содержит только одну итоговую строку. **Под ней отсутствуют документы движения** (`Отчет отдела...`, `Инвентаризация` и т.д.).
- **Обработка:** Исключается из расчетов.

### 2.2. Товар
- **Описание:** Конкретная номенклатурная позиция (например, "КАМБАЛА С ИКРОЙ ВЯЛЕНАЯ").
- **Ключевой признак:** Всегда имеет под собой **детализацию по документам движения**.
- **Обработка:** Является основной единицей для расчета коэффициента.

---

## 3. Финальная логика расчета коэффициентов (Строгий метод)

Скрипт использует единый, строгий метод для всех расчетов, основанный на детализации данных.

### 3.1. Обработка данных
- **Замена пустых ячеек:** При чтении отчета все пустые ячейки в числовых колонках (приход, расход, остатки) принудительно заменяются на **0**. Это обеспечивает бесперебойную работу алгоритма даже при неполной детализации.

### 3.2. Определение усушки
- **Основной метод:** Усушка вычисляется **только** для документа "Инвентаризация" путем суммирования разниц по каждой партии по формуле: `Усушка = Теоретический остаток - Фактический остаток`.
- **Источник данных:** Теоретический и фактический остатки берутся из детализации по партиям внутри документа "Инвентаризация".

### 3.3. Расчет дней хранения
- **Учет предыдущих инвентаризаций:** Чтобы не считать усушку за периоды, которые уже были закрыты, скрипт использует дату начала отчета (15.07.2025) как точку отсчета для "старых" партий.
    -   Если партия поступила **до** начала отчетного периода, дни ее хранения считаются с **15.07.2025**.
    -   Если партия поступила **внутри** отчетного периода, дни ее хранения считаются с **фактической даты прихода**.

### 3.4. Расчет коэффициента
- Коэффициент `a` вычисляется на основе **фактической усушки** (из п.3.2) и **ежедневной динамики веса** (рассчитанной с учетом п.3.1 и п.3.3).

---

## 4. Исключения

- **Групповые товары:** Товары, определенные по признаку из п. 2.1, **исключаются** из расчета.

---

## 5. Правило классификации
Классификация позиций на "товары" и "группы" должна производиться исключительно на основе структуры данных. Позиция считается "группой", если за ее названием не следует ни одного документа о движении. Фильтрация по ключевым словам в названии должна быть отключена.

---

## 6. Правило разработки
При разработке всегда следовать циклу:
1.  **Восстановить рабочую версию:** Убедиться, что текущая версия скрипта стабильна.
2.  **Проверить работоспособность:** Запустить скрипт и подтвердить, что он работает корректно.
3.  **Добавить изменения:** Внести новый код или правки.
4.  **Протестировать:** Запустить измененный скрипт и проверить результат.
