# Логика расчетов и обработка исходных данных

Этот документ является единым источником информации о бизнес-логике, обработке исходных данных и методологии расчетов, применяемых в системе.

## 1. Бизнес-логика системы

### 1.1. Цель
Система предназначена для автоматического и точного расчета **коэффициентов усушки** (естественной потери массы) продукции. Основная задача — анализ данных о недостачах из документов инвентаризации для выделения той части потерь, которая вызвана именно усушкой, а не другими факторами (порча, утеря, ошибки учета).

### 1.2. Ключевой принцип: Анализ недостач
Система не просто сравнивает баланс на начало и конец периода. Она целенаправленно анализирует **документированные недостачи**, выявленные в ходе инвентаризаций, и применяет модели для определения их причины. 

### 1.3. Принцип FIFO
При анализе движения товарных партий для определения возможных источников недостач система применяет бухгалтерский принцип **FIFO (First-In, First-Out)**. Эта логика реализована в самом приложении.

## 2. Чтение и обработка исходных данных

### 2.1. Требования к структуре данных
Система принимает на вход файлы **Excel (.xlsx, .xls)** или **JSON**. Каждая строка должна представлять одну номенклатурную позицию за отчетный период и содержать следующие поля:

*   `Номенклатура`: Наименование товара.
*   `Начальный_остаток`: Количество товара на дату начальной инвентаризации.
*   `Приход`: Суммарное поступление товара за период.
*   `Расход`: Суммарное списание товара за период.
*   `Конечный_остаток`: Количество товара на дату конечной инвентаризации.
*   `Период_хранения_дней`: Длительность периода в днях.

**Важно:** Корректность дат начала и конца периода, по которым берутся остатки, критически важна для точности расчетов.

### 2.2. Алгоритм обработки и валидации данных
При загрузке файла система последовательно выполняет следующие шаги:

1.  **Проверка наличия инвентаризаций:** Для каждой строки проверяется наличие данных в полях `Начальный_остаток` и `Конечный_остаток`.

2.  **Обработка отсутствующих данных:**
    *   Если **начальный остаток отсутствует** (значение `None`, `NaN` или пустая строка), система автоматически устанавливает его равным **0.0**. При этом в лог выводится предупреждение для пользователя: `WARNING | Для номенклатуры '{название}' отсутствует начальная инвентаризация... Устанавливаем начальный остаток равным 0.`
    *   Если **конечный остаток отсутствует**, система также выводит предупреждение.

3.  **Генерация отчета о нулевых остатках:** После этапа проверки система формирует отчет обо всех позициях, для которых начальный остаток был автоматически установлен в 0.0. Это позволяет пользователю проконтролировать корректность исходных данных.

## 3. Подробное описание расчета по исходным данным

### 3.1. Разделение причин недостач
После валидации данных система приступает к анализу. С помощью адаптивных моделей машинного обучения общая недостача по каждой позиции разделяется на две составляющие:
1.  Потери, связанные непосредственно с **усушкой**.
2.  Потери, связанные с **другими причинами**.

### 3.2. Расчет коэффициентов
Коэффициент усушки рассчитывается по формуле, где в числителе используется только та часть недостачи, которая была идентифицирована как усушка. Основная математическая модель, описывающая зависимость усушки от времени, выглядит так:

`S(t) = a * (1 - exp(-b*t)) + c*t`

Где:
*   `S(t)` — усушка в долях от начального остатка на момент времени `t`.
*   `t` — время хранения в днях.
*   `a`, `b`, `c` — коэффициенты модели, которые система подбирает в ходе анализа для каждой позиции.

### 3.3. Адаптация модели
Модель является адаптивной. Это значит, что ее коэффициенты могут корректироваться на основе:
*   Накопленных исторических данных.
*   **Типа продукции** (система различает свежую, соленую, копченую и вяленую рыбу).
*   Внешних факторов (температура, влажность), если они предоставлены в данных.
