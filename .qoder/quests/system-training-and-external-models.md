# Система обучения встроенного ИИ и использования внешних моделей

## 1. Обзор

Система расчета коэффициентов усушки включает в себя интеллектуальные компоненты, которые могут использовать как встроенный ИИ, так и внешние модели машинного обучения. Эта система позволяет адаптировать модель к реальным условиям на основе данных инвентаризации и использовать различные типы ИИ для различных задач. Особое внимание уделяется обратному взаимодействию с пользователем, позволяя сделать встроенный ИИ обучаемым на основе взаимодействий с пользователями.

### Содержание

1. Обзор
2. Архитектура системы
3. Встроенный ИИ
4. Адаптивная модель усушки
5. Внешние ИИ сервисы
6. Локальные ИИ модели
7. OpenRouter
8. Двойная LLM система
9. Механизм обратной связи
10. Техническая реализация
11. Рекомендации по выбору моделей
12. Безопасность и конфиденциальность
13. Мониторинг и оптимизация
14. Механизмы обучения встроенного ИИ
15. Интерфейс обратной связи
16. Метрики эффективности обучения
17. Оценка токенов и расчет стоимости
18. Режимы экономии токенов и адаптация к моделям
19. Обучение встроенного ИИ на истории чатов и рассуждение
19. Обучение встроенного ИИ на истории чатов и рассуждение

## 2. Архитектура системы

### 2.1 Компоненты системы

1. **Встроенный ИИ** - базовая система на основе ключевых слов
2. **Адаптивная модель усушки** - математическая модель с самообучением
3. **Внешние ИИ сервисы** - интеграция с OpenAI, Claude и другими
4. **Локальные ИИ модели** - использование LM Studio
5. **OpenRouter** - платформа для доступа к множеству моделей
6. **Двойная LLM система** - разделение задач между специализированными моделями

### 2.2 Взаимодействие компонентов

```
graph TD
    A[Пользовательский интерфейс] --> B[AIChat класс]
    B --> C[Встроенный ИИ]
    B --> D[Внешние ИИ сервисы]
    B --> E[Локальные ИИ модели]
    B --> F[OpenRouter]
    B --> G[Двойная LLM система]
    G --> H[LLM для расчетов]
    G --> I[LLM для анализа паттернов]
    A --> J[Адаптивная модель усушки]
    J --> K[Самообучение на основе инвентаризации]
    A --> L[Механизм обратной связи]
    L --> C
    L --> J
```

## 3. Встроенный ИИ

### 3.1 Архитектура

Встроенный ИИ реализован в классе `AIChat` и предоставляет базовую функциональность для помощи пользователям. Он работает на основе анализа ключевых слов в запросах пользователя и может обучаться на основе взаимодействий.

### 3.2 Возможности

- Ответы на часто задаваемые вопросы о системе
- Помощь в подготовке данных
- Объяснение результатов расчетов
- Рекомендации по использованию системы
- Обучение на основе взаимодействий с пользователем
- Рассуждение и логический вывод для решения сложных задач

### 3.3 Ограничения

- Предопределенные ответы
- Ограниченная способность к сложным рассуждениям
- Ограниченная адаптация без внешних моделей (до реализации полного механизма обучения)

## 4. Адаптивная модель усушки

### 4.1 Самообучение

Адаптивная модель усушки использует данные инвентаризации для самообучения и улучшения точности прогнозов.

#### Механизм обучения:
1. Сравнение прогнозов с реальными результатами инвентаризации
2. Расчет ошибки прогноза
3. Адаптация параметров модели
4. Создание новых версий модели при необходимости

### 4.2 Классы реализации

- `AdaptiveShrinkageModel` - основная адаптивная модель
- `SelfLearningShrinkageModel` - самообучающаяся модель
- `ShrinkageAdaptationAPI` - API для адаптации модели

### 4.3 Обучение на основе пользовательских данных

Модель может адаптироваться не только на основе инвентаризации, но и на основе корректировок, внесенных пользователем в результаты расчетов. Все взаимодействия пользователя с системой документируются и используются для улучшения будущих автоматических решений.

## 5. Внешние ИИ сервисы

### 5.1 Поддерживаемые платформы

1. **OpenAI** (GPT-3.5, GPT-4, GPT-4 Turbo)
2. **Anthropic Claude**
3. **Google Gemini**
4. **Другие совместимые сервисы**

### 5.2 Оценка стоимости использования

Система предоставляет предварительную оценку количества токенов и стоимости использования платных ИИ моделей:

1. **Оценка токенов** - предварительный подсчет количества токенов, необходимых для запроса
2. **Расчет стоимости** - оценка стоимости на основе тарифов поставщика ИИ
3. **Предупреждение о стоимости** - уведомление пользователя о предполагаемой стоимости перед выполнением запроса
4. **Лимиты расходов** - настройка максимальной стоимости запроса для предотвращения непредвиденных расходов

### 5.3 Настройка

- API ключ
- Выбор модели
- Базовый URL (для совместимых сервисов)
- Температура и другие параметры
- Лимиты расходов на использование ИИ
- Настройки оценки токенов и стоимости
- Режимы экономии токенов
- Адаптация под особенности каждой модели

## 6. Локальные ИИ модели

### 6.1 Поддерживаемые модели

1. **Llama 2/3** (7B, 13B, 70B)
2. **Mistral** (7B)
3. **Mixtral** (8x7B)
4. **Qwen3** (8B, 72B) - отличная поддержка русского языка
5. **Gemma3** (8B) - хорошая поддержка русского языка
6. **ruGPT-3.5** - специализированная русскоязычная модель

### 6.2 Настройка

- Установка LM Studio
- Загрузка и запуск модели
- Настройка URL сервера
- Выбор модели

## 7. OpenRouter

### 7.1 Преимущества

- Доступ к более чем 400 моделям ИИ
- Единый API для разных поставщиков
- Конкуренция цен между провайдерами
- Автоматическое распределение нагрузки

### 7.2 Категоризация моделей

1. **Бесплатные модели**
   - mistralai/mistral-7b-instruct
   - nousresearch/nous-capybara-7b
   - openchat/openchat-7b
   - undi95/toppy-m-7b

2. **Платные модели**
   - openai/gpt-4
   - anthropic/claude-3-sonnet
   - google/gemini-pro
   - meta-llama/llama-3-8b-instruct

## 8. Двойная LLM система

### 8.1 Архитектура

Система использует две специализированные модели:
1. **LLM для расчетов** - точные математические расчеты
2. **LLM для анализа паттернов** - выявление закономерностей

### 8.2 Преимущества

- Специализация каждой модели под свою задачу
- Повышенная эффективность
- Гибкость в выборе поставщиков
- Независимое масштабирование

## 9. Механизм обратной связи

### 9.1 Цикл "Прогноз -> Реальность -> Обучение"

Система использует результаты инвентаризации для автоматического дообучения модели:

1. **Прогноз** - модель делает предсказания на основе текущих параметров
2. **Реальность** - данные инвентаризации предоставляют фактические результаты
3. **Обучение** - модель адаптируется на основе расхождений

### 9.2 Использование данных инвентаризации

- Сравнение прогнозируемых и фактических значений усушки
- Расчет метрик точности (R², RMSE, MAE)
- Адаптация коэффициентов модели

### 9.3 Обратная связь от пользователя

Система собирает и анализирует взаимодействия пользователя для обучения встроенного ИИ:

1. **Анализ запросов и ответов** - сбор статистики по часто задаваемым вопросам
2. **Оценка полезности ответов** - механизм оценки качества ответов пользователем
3. **Коррекция ответов** - возможность пользователя корректировать или уточнять ответы
4. **Обновление базы знаний** - автоматическое обновление шаблонов ответов на основе успешных взаимодействий
5. **Обучение на оценках** - использование рейтингов ответов для улучшения качества будущих ответов

## 10. Техническая реализация

### 10.1 Основные классы

#### AIChat
Реализует функциональность ИИ-чата:
- `get_response()` - получение ответа на общий запрос
- `get_calculation_response()` - получение ответа для расчетов
- `get_pattern_analysis_response()` - получение ответа для анализа паттернов
- `get_external_ai_response()` - взаимодействие с внешним ИИ
- `get_local_ai_response()` - взаимодействие с локальным ИИ
- `update_knowledge_base()` - обновление базы знаний на основе взаимодействий
- `analyze_user_feedback()` - анализ обратной связи от пользователя
- `estimate_tokens_and_cost()` - оценка количества токенов и стоимости запроса
- `check_cost_limits()` - проверка лимитов расходов перед выполнением запроса
- `apply_token_saving_mode()` - применение режима экономии токенов
- `adapt_to_model_specifics()` - адаптация под особенности конкретной модели
- `train_on_chat_history()` - обучение на истории чатов на основе оценок пользователей
- `reasoning_engine()` - механизм рассуждения для решения сложных задач
- `apply_token_saving_mode()` - применение режима экономии токенов
- `adapt_to_model_specifics()` - адаптация под особенности конкретной модели

#### AdaptiveShrinkageModel
Реализует адаптивную модель усушки:
- `adapt_coefficients()` - адаптация коэффициентов на основе новых данных
- `determine_product_type()` - определение типа продукции
- `set_surplus_rate()` - установка процента излишка

#### SelfLearningShrinkageModel
Реализует самообучение:
- `learn_from_results()` - обучение на основе сравнения прогнозов с реальностью
- `auto_tune_parameters()` - автоматическая настройка параметров

### 10.2 Файлы конфигурации

- `результаты/ai_chat_settings.json` - настройки ИИ-чата
- `результаты/ai_chat_history.json` - история чата
- `результаты/ai_knowledge_base.json` - база знаний встроенного ИИ
- `результаты/user_feedback.json` - обратная связь от пользователей
- `результаты/ai_training_data.json` - данные для обучения встроенного ИИ
- `результаты/chat_ratings.json` - оценки и отзывы пользователей

## 11. Рекомендации по выбору моделей

### 11.1 По задачам

#### Для расчетов:
- GPT-3.5 Turbo
- Llama 3 8B
- Qwen 3 8B

#### Для анализа паттернов:
- GPT-4
- Claude 3 Sonnet
- Llama 3 70B

### 11.2 По аппаратным ресурсам

#### Ограниченные ресурсы:
- Qwen3 4B
- Gemma3 4B
- mistralai/mistral-7b-instruct

#### Средние конфигурации:
- Llama 3 8B
- Qwen3 8B
- gpt-4

#### Мощные конфигурации:
- Llama 3 70B
- Mixtral 8x7B
- gpt-4-turbo

## 12. Безопасность и конфиденциальность

### 12.1 Уровни конфиденциальности

1. **Встроенный ИИ** - максимальная конфиденциальность
2. **Локальный ИИ** - полная конфиденциальность
3. **Внешний ИИ** - возможна передача данных
4. **OpenRouter** - возможна передача данных

### 12.2 Рекомендации

- Использовать локальный ИИ для конфиденциальных данных
- Хранить API ключи безопасно
- Регулярно обновлять настройки безопасности
- Устанавливать лимиты расходов на использование платных ИИ сервисов
- Проверять предварительную оценку стоимости перед выполнением запросов
- Использовать режимы экономии токенов для оптимизации расходов
- Адаптировать запросы под особенности конкретных моделей для повышения эффективности

## 13. Мониторинг и оптимизация

### 13.1 Метрики производительности

- Точность прогнозов (R², RMSE, MAE)
- Время отклика моделей
- Частота ошибок
- История версий моделей
- Эффективность обучения на основе пользовательских взаимодействий
- Экономия токенов при использовании режимов оптимизации
- Эффективность адаптации под различные модели
- Качество ответов встроенного ИИ на основе пользовательских оценок
- Эффективность механизма рассуждения

### 13.2 Автоматическая оптимизация

- Адаптация скорости обучения
- Создание новых версий моделей
- Автоматический подбор параметров
- Адаптация на основе пользовательской обратной связи
- Оптимизация расхода токенов на основе статистики использования
- Автоматический выбор наиболее эффективного режима экономии токенов
- Оптимизация алгоритмов рассуждения на основе успешных решений

## 14. Механизмы обучения встроенного ИИ

### 14.1 Сбор данных

Система собирает следующую информацию для обучения встроенного ИИ:

1. **История взаимодействий** - все запросы и ответы сохраняются в файл `результаты/ai_chat_history.json`
2. **Оценки пользователей** - пользователи могут оценивать полезность ответов
3. **Корректировки** - пользователи могут предлагать уточнения или исправления
4. **Паттерны запросов** - анализ частоты и типов запросов

### 14.2 Алгоритмы обучения

1. **Частотный анализ** - определение наиболее часто задаваемых вопросов
2. **Кластеризация запросов** - группировка похожих запросов для создания более точных ответов
3. **Адаптация шаблонов** - обновление шаблонов ответов на основе успешных взаимодействий
4. **Расширение базы знаний** - добавление новых тем и ответов на основе анализа запросов
5. **Обучение на оценках** - использование пользовательских оценок для определения качества ответов и улучшения алгоритмов
6. **Анализ успешных взаимодействий** - изучение высокооцененных диалогов для выявления эффективных паттернов общения

### 14.3 Обновление базы знаний

База знаний встроенного ИИ хранится в файле `результаты/ai_knowledge_base.json` и включает:

1. **Шаблоны вопросов и ответов** - ключевые слова и соответствующие ответы
2. **Тематические категории** - группы связанных вопросов
3. **Статистика использования** - частота запросов и оценки полезности
4. **Версии знаний** - история изменений для отката при необходимости

## 15. Интерфейс обратной связи

### 15.1 Элементы интерфейса

В графических интерфейсах системы предусмотрены элементы для предоставления обратной связи:

1. **Кнопки оценки** - "Полезно"/"Не очень полезно" для каждого ответа ИИ
2. **Форма корректировки** - возможность пользователя уточнить или исправить ответ
3. **Предложения по улучшению** - форма для отправки предложений по развитию ИИ
4. **Подробные рейтинги** - возможность оценить ответ по шкале от 1 до 5 звезд с комментариями

### 15.2 Обработка обратной связи

1. **Автоматическая категоризация** - систематизация отзывов по темам
2. **Приоритизация** - определение наиболее важных улучшений
3. **Интеграция в обучение** - использование отзывов для адаптации модели
4. **Отчетность** - статистика по обратной связи для разработчиков

## 16. Метрики эффективности обучения

### 16.1 Метрики взаимодействия

- Частота обращений к ИИ
- Среднее время взаимодействия
- Уровень удовлетворенности пользователей
- Количество корректировок от пользователей
- Средний рейтинг ответов ИИ

### 16.2 Метрики обучения

- Количество новых шаблонов ответов
- Частота обновления базы знаний
- Улучшение релевантности ответов
- Снижение количества обращений к внешним ИИ
- Повышение среднего рейтинга ответов
- Увеличение точности решений сложных задач

## 17. Оценка токенов и расчет стоимости

### 17.1 Предварительная оценка токенов

Система предоставляет возможность предварительной оценки количества токенов, необходимых для выполнения запроса к платным ИИ моделям:

1. **Анализ объема данных** - подсчет количества символов, слов и строк в запросе
2. **Оценка сложности запроса** - определение примерного количества токенов на основе типа запроса
3. **Учет контекста** - учет истории чата и контекста при оценке общего количества токенов
4. **Прогнозирование ответа** - оценка количества токенов в предполагаемом ответе

### 17.2 Расчет стоимости

Система автоматически рассчитывает предполагаемую стоимость использования платных ИИ моделей:

1. **Получение тарифов** - автоматическое получение актуальных цен на токены от поставщиков ИИ
2. **Расчет входящих токенов** - стоимость обработки входного запроса
3. **Расчет исходящих токенов** - стоимость генерации ответа
4. **Общая стоимость** - суммарная стоимость запроса с учетом всех факторов
5. **Учет режимов экономии** - корректировка оценки стоимости с учетом выбранного режима экономии токенов

### 17.3 Управление расходами

Для предотвращения непредвиденных расходов система предоставляет инструменты управления расходами:

1. **Лимиты на запрос** - установка максимальной стоимости для одного запроса
2. **Лимиты на сессию** - ограничение общих расходов в рамках одной сессии работы
3. **Предупреждения** - уведомления пользователю о приближении к лимитам
4. **Блокировка запросов** - автоматическая блокировка запросов, превышающих установленные лимиты

### 17.4 Поддерживаемые модели и тарифы

Система поддерживает расчет стоимости для следующих популярных моделей:

#### OpenAI
- **GPT-3.5 Turbo**: $0.0015 за 1000 входящих токенов, $0.002 за 1000 исходящих токенов
- **GPT-4**: $0.03 за 1000 входящих токенов, $0.06 за 1000 исходящих токенов
- **GPT-4 Turbo**: $0.01 за 1000 входящих токенов, $0.03 за 1000 исходящих токенов

#### Anthropic Claude
- **Claude 3 Haiku**: $0.00025 за 1000 входящих токенов, $0.00125 за 1000 исходящих токенов
- **Claude 3 Sonnet**: $0.003 за 1000 входящих токенов, $0.015 за 1000 исходящих токенов
- **Claude 3 Opus**: $0.015 за 1000 входящих токенов, $0.075 за 1000 исходящих токенов

#### Google Gemini
- **Gemini Pro**: $0.0005 за 1000 входящих токенов, $0.0015 за 1000 исходящих токенов
- **Gemini Ultra**: $0.001 за 1000 входящих токенов, $0.003 за 1000 исходящих токенов

### 17.5 Техническая реализация

#### Методы оценки
- `estimate_tokens()` - оценка количества токенов в тексте
- `calculate_cost()` - расчет стоимости на основе тарифов
- `check_limits()` - проверка лимитов перед выполнением запроса
- `get_pricing_info()` - получение актуальной информации о ценах

#### Файлы конфигурации
- `результаты/ai_pricing.json` - актуальные тарифы поставщиков ИИ
- `результаты/cost_limits.json` - установленные пользователем лимиты расходов

## 18. Режимы экономии токенов и адаптация к моделям

### 18.1 Режимы экономии токенов

Система предоставляет различные режимы экономии токенов для оптимизации расходов при использовании платных ИИ сервисов:

#### Экономичный режим
- **Сжатие контекста** - сокращение истории чата до минимально необходимого объема
- **Оптимизация запросов** - упрощение формулировок и удаление избыточной информации
- **Кэширование ответов** - сохранение и повторное использование ответов на повторяющиеся запросы
- **Ограничение длины ответа** - установка максимальной длины ответа от ИИ

#### Агрессивный режим экономии
- **Минимизация контекста** - использование только актуальной информации без истории
- **Фрагментация запросов** - разделение сложных запросов на несколько простых
- **Использование встроенного ИИ** - приоритет встроенного ИИ перед внешними сервисами
- **Автоматическое резюмирование** - сокращение входных данных до ключевых точек

#### Интеллектуальный режим
- **Адаптивное сжатие** - автоматическое определение важности информации для сохранения
- **Селективная история** - сохранение только релевантных частей истории чата
- **Оптимизация на основе модели** - применение специфических оптимизаций для каждой модели
- **Предиктивное кэширование** - предварительное кэширование ответов на вероятные запросы

### 18.2 Адаптация к особенностям моделей

Система автоматически адаптирует запросы и параметры под особенности каждой ИИ модели:

#### Адаптация под OpenAI модели
- **Формат сообщений** - использование специфического формата сообщений OpenAI
- **Параметры температуры** - автоматическая настройка температуры в зависимости от задачи
- **Максимальная длина контекста** - учет ограничений по длине контекста (4096-128000 токенов)
- **Использование функций** - применение function calling для структурированных ответов

#### Адаптация под Anthropic Claude
- **Формат подсказок** - использование специфического формата подсказок Claude
- **Роли сообщений** - правильное использование ролей human/assistant
- **Обработка длинных контекстов** - оптимизация для моделей с поддержкой 200K токенов
- **Предотвращение цензуры** - адаптация запросов для минимизации блокировок

#### Адаптация под Google Gemini
- **Формат запросов** - использование специфического API Gemini
- **Настройки безопасности** - автоматическая настройка фильтров безопасности
- **Мультимодальность** - поддержка изображений и других типов данных
- **Оптимизация для русского языка** - использование рекомендаций для лучшей работы с русским языком

#### Адаптация под локальные модели
- **Оптимизация под формат GGUF** - использование специфики формата для лучшей производительности
- **Настройка параметров запуска** - автоматическая настройка параметров LM Studio
- **Учет ограничений ресурсов** - адаптация под доступные вычислительные ресурсы
- **Кэширование на локальном устройстве** - эффективное использование локального кэша

### 18.3 Техническая реализация

#### Методы адаптации
- `apply_token_saving_mode()` - применение выбранного режима экономии токенов
- `adapt_prompt_for_model()` - адаптация подсказки под конкретную модель
- `optimize_context_length()` - оптимизация длины контекста
- `compress_input_data()` - сжатие входных данных
- `cache_response()` - кэширование ответов ИИ

#### Конфигурация режимов
- `результаты/token_saving_modes.json` - настройки различных режимов экономии токенов
- `результаты/model_adaptations.json` - адаптации под особенности конкретных моделей
- `результаты/token_optimization_stats.json` - статистика эффективности оптимизаций

## 19. Обучение встроенного ИИ на истории чатов и рассуждение

### 19.1 Обучение на основе оценок пользователей

Система использует оценки пользователей для обучения и улучшения встроенного ИИ:

#### Сбор оценок
- **Рейтинговая система** - пользователи могут оценивать ответы по шкале от 1 до 5 звезд
- **Качественные отзывы** - пользователи могут оставлять текстовые комментарии к оценкам
- **Анализ поведения** - система отслеживает, какие ответы приводят к повторным запросам

#### Алгоритмы обучения
- **Взвешенное обучение** - более высокие оценки имеют больший вес при обучении
- **Анализ негативных отзывов** - система изучает причины низких оценок для улучшения
- **Выявление паттернов успеха** - анализ высокооцененных диалогов для выявления эффективных подходов

#### Обновление базы знаний
- **Автоматическая корректировка** - система автоматически корректирует шаблоны ответов на основе оценок
- **Ручная модерация** - администраторы могут вручную утверждать изменения в базе знаний
- **Версионирование** - система сохраняет историю изменений для возможности отката

### 19.2 Механизм рассуждения

Встроенный ИИ включает механизм рассуждения для решения сложных задач:

#### Логический вывод
- **Анализ цепочек** - система может следовать логическим цепочкам для решения задач
- **Построение гипотез** - формирование и проверка гипотез на основе доступной информации
- **Выводы на основе данных** - использование статистики и аналитики для принятия решений

#### Решение сложных задач
- **Декомпозиция проблем** - разбиение сложных задач на более простые подзадачи
- **Пошаговое решение** - предоставление подробных объяснений каждого шага решения
- **Проверка результатов** - система проверяет логическую согласованность своих выводов

#### Интеграция с предметной областью
- **Понимание усушки** - специализированные знания о процессах усушки в рыбной промышленности
- **Финансовый анализ** - понимание экономических аспектов расчетов усушки
- **Работа с данными** - интерпретация и анализ данных инвентаризации

### 19.3 Техническая реализация

#### Методы обучения
- `train_on_chat_history()` - обучение на истории чатов на основе пользовательских оценок
- `analyze_user_ratings()` - анализ рейтингов и отзывов пользователей
- `update_response_templates()` - обновление шаблонов ответов на основе обучения
- `reasoning_engine()` - механизм рассуждения для решения сложных задач
- `hypothesis_generator()` - генератор гипотез для анализа ситуаций

#### Файлы конфигурации
- `результаты/ai_training_data.json` - данные для обучения встроенного ИИ
- `результаты/chat_ratings.json` - оценки и отзывы пользователей
- `результаты/reasoning_patterns.json` - паттерны рассуждений и логические правила
- `результаты/training_logs.json` - журнал обучения ИИ

#### Метрики эффективности
- **Точность ответов** - процент правильно предоставленных ответов
- **Удовлетворенность пользователей** - средний рейтинг ответов
- **Снижение обращений к внешним ИИ** - уменьшение необходимости использования платных сервисов
- **Скорость обучения** - время, необходимое для достижения определенного уровня качества
