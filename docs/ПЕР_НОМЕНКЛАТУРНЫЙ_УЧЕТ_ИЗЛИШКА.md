# ПЕР-НОМЕНКЛАТУРНЫЙ УЧЕТ ПОСТОЯННОГО ИЗЛИШКА ПРИ ПОСТУПЛЕНИИ

## Введение

В рамках развития системы расчета коэффициентов нелинейной усушки была реализована важная функциональность - учет постоянного излишка при поступлении товара на пер-номенклатурной основе. Ранее система поддерживала только глобальный средний процент излишка, что не позволяло точно учитывать различия в излишках для разных видов продукции.

## Проблема

Ранее реализация имела следующие ограничения:
- Глобальный процент излишка применялся ко всем номенклатурам
- Невозможность задать индивидуальные значения излишка для разных товаров
- Неточность расчетов для товаров с разными процентами излишка

## Решение

Была реализована пер-номенклатурная система учета излишка:

### 1. Адаптивная модель расчета усушки
В классе `AdaptiveShrinkageModel` добавлены новые методы:
- `set_surplus_rate(surplus_rate, nomenclature=None)` - установка процента излишка
- `get_surplus_rate(nomenclature=None)` - получение процента излишка
- Модифицированы методы `adapt_coefficients()` и `predict_with_adaptation()` для учета номенклатуры

### 2. Основная система расчета
В классе `ShrinkageSystem` добавлены аналогичные методы:
- `set_surplus_rate(surplus_rate, nomenclature=None)` - установка процента излишка
- `get_surplus_rate(nomenclature=None)` - получение процента излишка

### 3. Обратная совместимость
Сохранена полная обратная совместимость:
- При вызове методов без указания номенклатуры используется глобальное значение
- Все существующие скрипты продолжают работать без изменений

## Пример использования

### Использование напрямую через адаптивную модель:

```python
from adaptive_shrinkage_calculator import AdaptiveShrinkageModel

# Создание модели
model = AdaptiveShrinkageModel()

# Установка процентов излишка для разных номенклатур
model.set_surplus_rate(0.05, "СКУМБРИЯ ХК")  # 5% излишка для скумбрии
model.set_surplus_rate(0.10, "СЕЛЬДЬ ХК")    # 10% излишка для сельди
model.set_surplus_rate(0.03, "ОКУНЬ ХК")     # 3% излишка для окуня

# Данные для расчета
product_data = {
    'initial_balance': 100.0,
    'incoming': 0,
    'outgoing': 0,
    'final_balance': 95.0,
    'storage_days': 7
}

# Адаптация коэффициентов с учетом излишка для конкретной номенклатуры
coefficients = model.adapt_coefficients(
    product_data,
    nomenclature="СКУМБРИЯ ХК"
)

# Прогноз усушки с учетом излишка для конкретной номенклатуры
forecast = model.predict_with_adaptation(
    t=7,
    initial_balance=100.0,
    nomenclature="СКУМБРИЯ ХК"
)

print(f"Прогноз усушки для СКУМБРИИ ХК: {forecast:.3f} кг")
```

### Использование через основную систему:

```python
from shrinkage_system import ShrinkageSystem

# Создание системы
system = ShrinkageSystem()

# Установка процентов излишка для разных номенклатур
system.set_surplus_rate(0.05, "СКУМБРИЯ ХК")  # 5% излишка для скумбрии
system.set_surplus_rate(0.10, "СЕЛЬДЬ ХК")    # 10% излишка для сельди
system.set_surplus_rate(0.03, "ОКУНЬ ХК")     # 3% излишка для окуня

# Расчет коэффициентов с использованием адаптивной модели
results = system.calculate_coefficients_only("отчет.xlsx", use_adaptive=True)

# Предварительный расчет усушки с учетом излишка
current_balances = {"СКУМБРИЯ ХК": 10.5, "СЕЛЬДЬ ХК": 5.2, "ОКУНЬ ХК": 3.8}
coefficients = {result['Номенклатура']: {'a': result['a'], 'b': result['b'], 'c': result['c']} 
                for result in results}
preliminary = system.calculate_preliminary_only(current_balances, coefficients)
```

## Технические детали

### 1. Структура данных

В классах `AdaptiveShrinkageModel` и `ShrinkageSystem` добавлен словарь для хранения процентов излишка:

```python
self.surplus_rates = {}  # {nomenclature: surplus_rate}
```

### 2. Методы

#### set_surplus_rate(surplus_rate, nomenclature=None)
Устанавливает процент излишка для указанной номенклатуры или глобальное значение.

#### get_surplus_rate(nomenclature=None)
Возвращает процент излишка для указанной номенклатуры или глобальное значение.

#### adapt_coefficients(new_data, nomenclature=None)
Адаптирует коэффициенты с учетом излишка для указанной номенклатуры.

#### predict_with_adaptation(t, nomenclature=None)
Прогнозирует усушку с учетом излишка для указанной номенклатуры.

### 3. Обратная совместимость

Все изменения сохраняют полную обратную совместимость:
- Старые скрипты продолжают работать без изменений
- При вызове методов без указания номенклатуры используются глобальные значения
- Новые функции являются дополнительными, а не заменяющими существующие

## Тестирование

Реализация прошла все тесты:
- ✅ Базовая адаптивная модель расчета коэффициентов усушки
- ✅ Модель партий
- ✅ Адаптация к условиям хранения
- ✅ Адаптация к типу продукции
- ✅ Учет постоянного излишка при поступлении (глобальный)
- ✅ Учет постоянного излишка при поступлении (пер-номенклатурный)
- ✅ Коррекция данных с учетом излишка
- ✅ Все новые функции корректно работают

## Преимущества

1. **Точность расчетов** - каждый вид продукции может иметь свой процент излишка
2. **Гибкость** - возможность настройки излишка для каждой номенклатуры
3. **Обратная совместимость** - старые скрипты продолжают работать
4. **Простота использования** - интуитивный API для установки и получения значений

## Заключение

Реализация пер-номенклатурного учета излишка значительно повысила точность расчетов системы усушки. Новая функциональность позволяет учитывать индивидуальные характеристики каждой номенклатуры, что делает систему более гибкой и точной в реальных условиях эксплуатации.