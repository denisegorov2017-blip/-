# План реализации системы базы данных для расчета коэффициентов усушки

## Обзор

Этот документ описывает план реализации системы базы данных для хранения и управления данными, связанными с расчетом коэффициентов усушки рыбы и рыбопродуктов. Система будет интегрирована с существующей архитектурой проекта "Система Расчета Усушки".

## Цели реализации

1. **Хранение исторических данных**: Постоянное хранение данных инвентаризации, коэффициентов усушки и результатов расчетов
2. **Улучшение производительности**: Быстрый доступ к данным и оптимизация запросов
3. **Поддержка адаптивных моделей**: Хранение исторических данных для обучения и адаптации моделей
4. **Аналитика и отчетность**: Генерация аналитических отчетов на основе накопленных данных
5. **Интеграция с существующей системой**: Бесшовная интеграция с текущими компонентами системы

## Архитектура базы данных

### Технологический стек

- **База данных**: SQLite (встраиваемая, легковесная, не требует отдельного сервера)
- **ORM**: SQLAlchemy (для удобной работы с базой данных в Python)
- **Миграции**: Alembic (для управления изменениями схемы базы данных)

### Структура базы данных

#### 1. Таблица `nomenclature` (Номенклатура)
```sql
CREATE TABLE nomenclature (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    product_type TEXT NOT NULL, -- fresh_fish, salt_cured, cold_smoked, etc.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. Таблица `inventory_records` (Записи инвентаризации)
```sql
CREATE TABLE inventory_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomenclature_id INTEGER NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    initial_balance REAL NOT NULL,
    incoming REAL NOT NULL,
    outgoing REAL NOT NULL,
    final_balance REAL NOT NULL,
    storage_days INTEGER NOT NULL,
    shrinkage_amount REAL, -- Фактическая недостача из инвентаризации
    shrinkage_coefficient REAL, -- Коэффициент усушки
    other_losses REAL, -- Другие потери
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (nomenclature_id) REFERENCES nomenclature(id)
);
```

#### 3. Таблица `shrinkage_coefficients` (Коэффициенты усушки)
```sql
CREATE TABLE shrinkage_coefficients (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomenclature_id INTEGER NOT NULL,
    model_type TEXT NOT NULL, -- exponential, linear, polynomial
    coefficient_a REAL,
    coefficient_b REAL,
    coefficient_c REAL,
    accuracy REAL, -- Точность модели
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    data_points INTEGER, -- Количество точек данных
    is_adaptive BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (nomenclature_id) REFERENCES nomenclature(id)
);
```

#### 4. Таблица `predictions` (Прогнозы)
```sql
CREATE TABLE predictions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomenclature_id INTEGER NOT NULL,
    initial_balance REAL NOT NULL,
    predicted_shrinkage REAL NOT NULL,
    shrinkage_rate REAL NOT NULL,
    final_balance REAL NOT NULL,
    days INTEGER NOT NULL,
    model_type TEXT NOT NULL,
    coefficient_a REAL,
    coefficient_b REAL,
    coefficient_c REAL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (nomenclature_id) REFERENCES nomenclature(id)
);
```

#### 5. Таблица `calculation_logs` (Логи расчетов)
```sql
CREATE TABLE calculation_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nomenclature_id INTEGER NOT NULL,
    operation_type TEXT NOT NULL, -- calculation, prediction, adaptation
    status TEXT NOT NULL, -- success, error, warning
    message TEXT,
    details TEXT, -- JSON с деталями
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (nomenclature_id) REFERENCES nomenclature(id)
);
```

## Этапы реализации

### Этап 1: Подготовка инфраструктуры (Неделя 1)

#### Задачи:
1. Добавление зависимостей в [requirements.txt](file:///C:/Users/D_909/Desktop/%D0%B4%D0%BB%D1%8F%20%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0/requirements.txt):
   ```
   sqlalchemy>=1.4.0
   alembic>=1.7.0
   ```

2. Создание модуля базы данных `src/core/database.py`:
   - Настройка подключения к SQLite
   - Определение базовых классов моделей
   - Реализация функций инициализации базы данных

3. Создание моделей SQLAlchemy в `src/core/models.py`:
   - Определение всех таблиц как классов SQLAlchemy
   - Настройка связей между таблицами

4. Настройка миграций с помощью Alembic:
   - Инициализация Alembic в проекте
   - Создание первой миграции для инициализации схемы

### Этап 2: Интеграция с основной системой (Неделя 2)

#### Задачи:
1. Модификация [ShrinkageSystem](file:///C:/Users/D_909/Desktop/%D0%B4%D0%BB%D1%8F%20%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0/src/core/shrinkage_system.py#L36-L143) для работы с базой данных:
   - Добавление зависимости от модуля базы данных
   - Реализация сохранения результатов расчетов в базу данных
   - Реализация загрузки исторических данных для адаптивных моделей

2. Обновление [ShrinkageCalculator](file:///C:/Users/D_909/Desktop/%D0%B4%D0%BB%D1%8F%20%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0/src/core/shrinkage_calculator.py#L24-L586) и [AdaptiveShrinkageModel](file:///C:/Users/D_909/Desktop/%D0%B4%D0%BB%D1%8F%20%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0/src/core/adaptive_shrinkage_calculator.py#L30-L551):
   - Добавление функций для сохранения и загрузки коэффициентов
   - Реализация использования исторических данных для улучшения точности

3. Создание сервисного слоя `src/core/database_service.py`:
   - Реализация CRUD операций для всех сущностей
   - Реализация функций агрегации и аналитики

### Этап 3: Реализация логирования и мониторинга (Неделя 3)

#### Задачи:
1. Интеграция логирования операций с базой данных:
   - Автоматическое логирование всех операций записи
   - Сохранение ошибок и предупреждений в [calculation_logs](file:///C:/Users/D_909/Desktop/%D0%B4%D0%BB%D1%8F%20%D0%BD%D0%BE%D0%B2%D0%BE%D0%B3%D0%BE%20%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0/src/core/models.py#L155-L165)

2. Создание функций мониторинга производительности:
   - Замеры времени выполнения запросов
   - Статистика использования базы данных

3. Реализация механизма резервного копирования:
   - Автоматическое создание резервных копий базы данных
   - Возможность восстановления из резервной копии

### Этап 4: Создание интерфейса для работы с базой данных (Неделя 4)

#### Задачи:
1. Создание CLI интерфейса для администрирования базы данных:
   - Команды для инициализации, миграции и очистки базы данных
   - Команды для экспорта/импорта данных

2. Интеграция с GUI:
   - Добавление вкладки для просмотра данных из базы
   - Реализация функций фильтрации и поиска

3. Создание API для внешнего доступа (опционально):
   - REST API для получения данных из базы
   - Аутентификация и авторизация (при необходимости)

### Этап 5: Тестирование и оптимизация (Неделя 5)

#### Задачи:
1. Написание unit-тестов для модуля базы данных:
   - Тестирование всех CRUD операций
   - Тестирование связей между таблицами
   - Тестирование функций агрегации

2. Создание интеграционных тестов:
   - Тестирование интеграции с основной системой
   - Тестирование производительности при больших объемах данных

3. Оптимизация производительности:
   - Создание индексов для часто используемых запросов
   - Оптимизация сложных запросов
   - Настройка кэширования (при необходимости)

## Преимущества реализации

1. **Постоянное хранение данных**: Все результаты расчетов будут сохраняться для последующего анализа
2. **Улучшенная адаптивность**: Адаптивные модели смогут использовать исторические данные для повышения точности
3. **Аналитика и отчетность**: Возможность генерировать аналитические отчеты на основе накопленных данных
4. **Производительность**: Оптимизированный доступ к данным с помощью индексов и кэширования
5. **Масштабируемость**: Готовность к расширению функциональности в будущем

## Риски и меры по их минимизации

1. **Сложность миграции существующих данных**:
   - Мера: Создание скриптов для миграции существующих JSON файлов в базу данных

2. **Увеличение сложности системы**:
   - Мера: Постепенная интеграция с возможностью отключения функций базы данных

3. **Проблемы с производительностью при больших объемах данных**:
   - Мера: Реализация пагинации, индексов и кэширования

4. **Потеря совместимости с существующими компонентами**:
   - Мера: Сохранение обратной совместимости через адаптеры

## План интеграции с существующей системой

1. **Постепенное внедрение**: Новая функциональность будет добавлена как дополнительный модуль
2. **Сохранение обратной совместимости**: Существующие компоненты продолжат работать без изменений
3. **Конфигурируемость**: Использование базы данных будет опциональным, управляемым через конфигурацию
4. **Миграция данных**: Создание скриптов для переноса существующих данных из JSON файлов в базу данных

## Ожидаемые результаты

1. **Улучшенная точность адаптивных моделей** за счет использования исторических данных
2. **Быстрый доступ к данным** через оптимизированные запросы к базе данных
3. **Расширенные возможности аналитики** с возможностью генерации сложных отчетов
4. **Улучшенный пользовательский опыт** через интеграцию с GUI
5. **Готовность к масштабированию** для обработки больших объемов данных

## Следующие шаги

1. Создание технического задания для реализации каждого этапа
2. Определение приоритетов и сроков реализации
3. Назначение ответственных за реализацию каждого этапа
4. Создание системы мониторинга прогресса реализации