# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Система расчета коэффициентов нелинейной усушки и предварительного расчета усушки 1.1

### 1. ВВЕДЕНИЕ

#### 1.1 Назначение документа
Данный документ определяет технические требования к системе расчета коэффициентов нелинейной усушки и предварительного расчета усушки на основе отчетов в формате Excel. Система предназначена для автоматизации процесса расчета коэффициентов усушки и прогнозирования усушки без проведения инвентаризации, с учетом постоянного излишка при поступлении товара (пер-номенклатурный учет).

#### 1.2 Область применения
Система применяется для:
- Расчета коэффициентов нелинейной усушки на основе исторических данных
- Предварительного расчета усушки без проведения инвентаризации
- Генерации HTML отчетов с результатами расчетов
- Обработки отчетов в формате Excel с сохранением иерархии структуры
- Учета постоянного излишка при поступлении товара (пер-номенклатурный учет)

#### 1.3 Основания для разработки
Необходимость автоматизации расчета коэффициентов усушки и прогнозирования убыли продукции в процессе хранения с учетом постоянного излишка при поступлении, который может отличаться для разных номенклатур.

### 2. НАЗНАЧЕНИЕ И ЦЕЛИ СОЗДАНИЯ СИСТЕМЫ

#### 2.1 Назначение системы
Система предназначена для:
- Автоматического расчета коэффициентов нелинейной усушки по экспоненциальной модели
- Предварительного расчета усушки без проведения инвентаризации
- Обработки отчетов в формате Excel с сохранением иерархической структуры
- Генерации подробных HTML отчетов с результатами анализа
- Учета постоянного излишка при поступлении товара (пер-номенклатурный учет)

#### 2.2 Цели создания системы
- Повышение точности расчета коэффициентов усушки
- Сокращение времени на обработку отчетов
- Автоматизация процесса прогнозирования усушки
- Сохранение структуры исходных Excel отчетов при преобразовании
- Обеспечение возможности обратного преобразования данных
- Учет постоянного излишка при поступлении товара с возможностью настройки по номенклатурам

### 3. ХАРАКТЕРИСТИКА ОБЪЕКТА РАЗРАБОТКИ

#### 3.1 Назначение программного изделия
Программное изделие представляет собой систему для расчета коэффициентов нелинейной усушки и предварительного расчета усушки на основе отчетов в формате Excel с возможностью сохранения иерархической структуры файлов и учета постоянного излишка при поступлении товара (пер-номенклатурный учет).

#### 3.2 Условия эксплуатации
- ОС: Windows 10/11, Linux, macOS
- Интерпретатор: Python 3.7+
- ОЗУ: не менее 4 ГБ
- Свободное место на диске: не менее 100 МБ

#### 3.3 Требования к информационной и программной совместимости
- Совместимость с Excel файлами (.xlsx, .xlsm, .xls)
- Совместимость с HTML форматом для отчетов
- Совместимость с JSON форматом для обмена данными

### 4. ТРЕБОВАНИЯ К ПРОГРАММНОМУ ИЗДЕЛИЮ

#### 4.1 Требования к функциональным характеристикам

##### 4.1.1 Основные функции системы
1. **Чтение и обработка Excel файлов**
   - Высокопроизводительная обработка на базе Polars
   - Поддержка форматов .xlsx, .xlsm, .xls
   - Обработка многослойных файлов с сохранением иерархии
   - Извлечение данных из структурированных отчетов
   
2. **Сохранение иерархии Excel файлов**
   - Преобразование Excel → JSON с сохранением структуры
   - Преобразование JSON → Excel с восстановлением структуры
   - Работа с многослойными отчетами

3. **Расчет коэффициентов усушки**
   - Расчет по экспоненциальной модели: S(t) = a × (1 - e^(-b×t)) + c
   - Расчет по линейной модели
   - Расчет по полиномиальной модели
   - Адаптивная модель с самообучением
   - Учет постоянного излишка при поступлении товара (пер-номенклатурный учет)

4. **Предварительный расчет усушки**
   - Прогнозирование усушки без проведения инвентаризации
   - Расчет остатка с учетом прогнозируемой усушки
   - Учет постоянного излишка при поступлении товара (пер-номенклатурный учет)

5. **Генерация отчетов**
   - Создание HTML отчетов с результатами расчетов
   - Создание детализированных отчетов по каждой номенклатуре

##### 4.1.2 Требования к надежности
- Обработка ошибок чтения файлов
- Валидация входных данных
- Защита от некорректных значений
- Логирование ошибок и предупреждений

##### 4.1.3 Требования к безопасности
- Отсутствие доступа к системным ресурсам
- Работа только с предоставленными файлами
- Отсутствие сетевых подключений без согласия пользователя

#### 4.2 Требования к интерфейсу
- Консольный интерфейс для запуска расчетов
- Простой API для интеграции в другие системы
- Четкие сообщения об ошибках и результатах

#### 4.3 Требования к производительности
- Обработка файлов размером до 100 МБ
- Время обработки одного файла не более 30 секунд
- Минимальные требования к оперативной памяти

### 5. СОСТАВ И СОДЕРЖАНИЕ ПРОЕКТА

#### 5.1 Программные модули
1. **excel_parser_simple.py** - базовый парсер Excel файлов
2. **excel_utils.py** - дополнительные утилиты для работы с Excel
3. **excel_hierarchy_preserver.py** - модуль сохранения иерархии Excel файлов
4. **shrinkage_calculator.py** - калькулятор коэффициентов усушки
5. **shrinkage_system.py** - основная система расчета (обновлен для поддержки пер-номенклатурного учета излишка)
6. **adaptive_shrinkage_calculator.py** - адаптивная модель расчета усушки (обновлен для поддержки пер-номенклатурного учета излишка)
7. **shrinkage_html_reporter.py** - генератор HTML отчетов
8. **shrinkage_excel_parser.py** - высокопроизводительный парсер Excel на базе Polars

#### 5.2 Тестовые модули
1. **test_excel_parser.py** - тесты для парсера Excel
2. **test_adaptive_model.py** - тесты для адаптивной модели (обновлены для тестирования пер-номенклатурного учета излишка)
3. **test_excel_hierarchy.py** - тесты для сохранения иерархии Excel

#### 5.3 Документация
1. **ТЕХНИЧЕСКОЕ_ЗАДАНИЕ.md** - текущий документ (обновлен для отражения пер-номенклатурного учета излишка)
2. **README_simple.md** - руководство пользователя
3. **СПЕЦИФИКАЦИЯ_СТРУКТУРЫ_ОТЧЕТОВ.md** - спецификация структуры отчетов
4. **ПРИМЕР_РАСЧЕТА_СКУМБРИЯ_ХК.md** - пример расчета
5. **АДАПТИВНАЯ_МОДЕЛЬ_УСУШКИ.md** - описание адаптивной модели
6. **СОХРАНЕНИЕ_ИЕРАРХИИ_EXCEL.md** - описание возможностей сохранения иерархии Excel

### 6. ТРЕБОВАНИЯ К ЗАВИСИМОСТЯМ

#### 6.1 Обязательные зависимости
Для корректной работы системы необходимо наличие следующих библиотек:

1. **polars>=0.20.0** - основная библиотека для высокопроизводительной обработки данных
2. **pandas>=2.0.0** - библиотека для работы с данными (используется для совместимости)
3. **numpy>=1.20.0** - библиотека для численных вычислений, необходима для всех расчетов
4. **scipy>=1.7.0** - библиотека научных вычислений, необходима для оптимизации коэффициентов
5. **openpyxl>=3.0.0** - движок для чтения и записи новых Excel файлов (.xlsx, .xlsm)
6. **xlrd>=2.0.0** - движок для чтения старых Excel файлов (.xls)
7. **xlsxwriter>=3.0.0** - движок для записи Excel файлов с форматированием

#### 6.2 Опциональные зависимости
Для расширенной функциональности могут потребоваться следующие библиотеки:

1. **matplotlib>=3.5.0** - для визуализации данных (используется в enhanced_analytics.py)
2. **xlwt>=1.3.0** - для записи старых Excel файлов (.xls)
3. **python-dateutil>=2.8.0** - для лучшей обработки дат
4. **chardet>=5.0.0** - для автоопределения кодировки

#### 6.3 Стандартные библиотеки Python
Система также использует следующие стандартные библиотеки Python:
- **json** - для работы с JSON форматом
- **os, sys** - для работы с файловой системой
- **datetime** - для работы с датами
- **typing** - для аннотаций типов

### 7. ПОРЯДОК КОНТРОЛЯ И ПРИЕМКИ

#### 7.1 Виды испытаний
- Функциональное тестирование
- Тестирование производительности
- Тестирование обработки ошибок
- Тестирование сохранения иерархии Excel файлов
- Тестирование учета постоянного излишка при поступлении (пер-номенклатурный учет)

#### 7.2 Общие требования к приемке
- Все функции должны работать согласно техническому заданию
- Система должна корректно обрабатывать тестовые данные
- Документация должна быть полной и актуальной
- Система должна корректно учитывать постоянный излишок при поступлении товара с возможностью настройки по номенклатурам

### 8. ТРЕБОВАНИЯ К СОСТАВУ И ПАРАМЕТРАМ ТЕХНИЧЕСКИХ СРЕДСТВ

#### 8.1 Минимальные требования
- Процессор: 2 ядра с частотой 2 ГГц
- ОЗУ: 4 ГБ
- Свободное место на диске: 100 МБ
- ОС: Windows 10/11, Linux, macOS

### 9. ТРЕБОВАНИЯ К ИНФОРМАЦИОННОЙ И ПРОГРАММНОЙ ДОКУМЕНТАЦИИ

#### 9.1 Состав документации
- Техническое задание
- Руководство пользователя
- Программная документация
- Примеры использования

#### 9.2 Требования к оформлению
- Документация в формате Markdown
- Четкая структура и навигация
- Примеры кода и использования
- Скриншоты при необходимости

### 10. ПОРЯДОК РАЗРАБОТКИ И ВНЕСЕНИЯ ИЗМЕНЕНИЙ

#### 10.1 Этапы разработки

### 11. ВЗАИМОДЕЙСТВИЕ С ИИ И ПРЕДПОЧТИТЕЛЬНЫЕ МЕТОДЫ

#### 11.1 Цель
Обеспечение максимальной точности и эффективности при анализе данных, доработке и отладке системы с помощью инструментов ИИ (Gemini).

#### 11.2 Архитектурное требование
Система спроектирована по **JSON-центричному принципу**. Это означает, что ядро системы изолировано от "сырых" форматов данных и работает с унифицированной, структурированной моделью данных.

#### 11.3 Предпочтительный метод взаимодействия
Стандартный протокол для любой задачи, требующей анализа данных со стороны ИИ, включает следующие шаги:

1.  **Преобразование в канонический формат:** Исходный Excel-файл должен быть преобразован в канонический формат **JSON** с помощью модуля `excel_hierarchy_preserver.py`.
2.  **Предоставление данных ИИ:** Для анализа ИИ предоставляется исключительно полученный **JSON-файл**.

Этот метод является обязательным, так как он устраняет неоднозначность визуальной структуры Excel и предоставляет ИИ чистые, структурированные данные для анализа.

#### 11.4 Полный протокол
Все детали архитектуры, потока данных и принципов совместной работы задокументированы в файле **[GEMINI_SELF_GUIDE.md](GEMINI_SELF_GUIDE.md)**, который является неотъемлемой частью проектной документации.
