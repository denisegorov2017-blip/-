# ПРИМЕР РАСЧЕТА КОЭФФИЦИЕНТОВ УСУШКИ
## На примере номенклатуры "СКУМБРИЯ ХК"

### 1. ИСХОДНЫЕ ДАННЫЕ

Из файла [sheet_1_Лист_1.csv](file://c:\Users\D_909\Desktop\расчет%20коэффициентов%20нелинейной%20усушки,%20и%20предварительный%20расчет%20усушки%201.1\исходные_данные\Для_расчета_коэфф\sheet_1_Лист_1.csv) извлекаются следующие данные по номенклатуре "СКУМБРИЯ ХК":

#### 1.1 Основные показатели
````
СКУМБРИЯ ХК,,,,13.428,,0,1.428,12
```

- Начальный остаток: 13.428 кг
- Приход: 0 кг
- Расход: 1.428 кг
- Конечный остаток: 12.0 кг

#### 1.2 Детальные данные по документам
````
Отчет отдела о розничных продажах 000000000000218 от 15.07.2025 21:57:25,,,,13.428,,,0.264,13.164
02.07.2025 11:30:00,,,,13.428,,,0.264,13.164

Отчет отдела о розничных продажах 000000000000219 от 16.07.2025 22:10:57,,,,13.164,,,0.176,12.988
02.07.2025 11:30:00,,,,13.164,,,0.176,12.988

Отчет отдела о розничных продажах 000000000000220 от 17.07.2025 21:39:44,,,,12.988,,,0.2,12.788
02.07.2025 11:30:00,,,,12.988,,,0.2,12.788

Отчет отдела о розничных продажах 000000000000221 от 18.07.2025 21:48:28,,,,12.788,,,0.154,12.634
02.07.2025 11:30:00,,,,12.788,,,0.154,12.634

Отчет отдела о розничных продажах 000000000000222 от 19.07.2025 21:46:39,,,,12.634,,,0.108,12.526
02.07.2025 11:30:00,,,,12.634,,,0.108,12.526

Отчет отдела о розничных продажах 000000000000223 от 20.07.2025 21:47:29,,,,12.526,,,0.29,12.236
02.07.2025 11:30:00,,,,12.526,,,0.29,12.236

Отчет отдела о розничных продажах 000000000000224 от 21.07.2025 21:57:52,,,,12.236,,,0.13,12.106
02.07.2025 11:30:00,,,,12.236,,,0.13,12.106

Инвентаризация 000000000000158 от 21.07.2025 22:56:44,,,,12.106,,,0.106,12
02.07.2025 11:30:00,,,,12.106,,,0.106,12
```

### 2. ВАЖНОЕ ЗАМЕЧАНИЕ О СТРУКТУРЕ ДАННЫХ

**Важно понимать:** Исходные данные отражают общий баланс по номенклатуре за весь период, а не по конкретным партиям. Это накладывает ограничения на точность расчетов, так как усушка распределяется суммарно.

### 3. УЛУЧШЕНИЕ ТОЧНОСТИ ЧЕРЕЗ МАРКИРОВКУ ПАРТИЙ

#### 3.1 Идентификация партий
Для повышения точности расчетов предлагается внедрить систему маркировки партий:

````
Партия = {Номенклатура}_{Дата_прихода}_{Номер_документа}
Пример: СКУМБРИЯ_ХК_02.07.2025_000000000000547
```

#### 3.2 Извлечение информации о партиях
На основе существующих данных можно выделить партии по дате прихода:
- Партия 1: СКУМБРИЯ_ХК_02.07.2025 (начальный остаток 13.428 кг)
- Документы движения по этой партии:
  - Отчеты о продажах (уменьшают остаток)
  - Инвентаризация (финальное состояние)

#### 3.3 Расчет усушки по партиям
```python
# Пример структуры данных партии
batch_data = {
    'batch_id': 'СКУМБРИЯ_ХК_02.07.2025',
    'receipt_date': '02.07.2025',
    'initial_balance': 13.428,
    'incoming': 0,
    'outgoing': 1.428,
    'final_balance': 12.0,
    'shrinkage': 1.428,  # Рассчитанная усушка
    'storage_days': 19   # Период хранения до инвентаризации
}
```

### 4. УЧЕТ ПОСТОЯННОГО ИЗЛИШКА ПРИ ПОСТУПЛЕНИИ

#### 4.1 Проблема постоянного излишка
В некоторых случаях товар поступает с постоянным излишком (например, 5% сверх заказанного объема), но при этом также подвержен усушке во время хранения. Это требует корректировки расчетов:

- **Излишек при поступлении:** Постоянный процент (например, 5%)
- **Усушка при хранении:** Переменная величина, зависящая от времени и условий хранения

**ВАЖНО:** Излишек может отличаться для разных номенклатур. Например:
- СКУМБРИЯ ХК: 5% излишка
- СЕЛЬДЬ ХК: 10% излишка
- ОКУНЬ ХК: 3% излишка

#### 4.2 Модифицированная модель расчета
Для корректного учета необходимо применять двухэтапный подход:

1. **Коррекция входящих данных:**
   ```
   Фактический_приход = Документированный_приход × (1 + Процент_излишка_для_номенклатуры)
   Фактический_начальный_остаток = Начальный_остаток × (1 + Процент_излишка_для_номенклатуры)
   ```

2. **Расчет усушки от фактического объема:**
   ```
   Усушка(t) = Фактический_объем × [a × (1 - e^(-b×t)) + c×t]
   ```

3. **Итоговый остаток:**
   ```
   Итоговый_остаток = Фактический_приход - Усушка(t) ± Движение
   ```

#### 4.3 Пример расчета с излишком
Допустим, товар поступает с постоянным излишком 5% для СКУМБРИИ ХК:

```python
# Исходные данные
документированный_приход = 100.0  # кг
процент_излишка = 0.05  # 5% для СКУМБРИИ ХК

# Коррекция с учетом излишка
фактический_приход = документированный_приход * (1 + процент_излишка)
# фактический_приход = 105.0 кг

# Расчет усушки от фактического объема
коэффициенты = {'a': 1.2, 'b': 0.085, 'c': 0.012}
дней_хранения = 7

усушка = фактический_приход * (коэффициенты['a'] * (1 - math.exp(-коэффициенты['b'] * дней_хранения)) + 
                              коэффициенты['c'] * дней_хранения)
# усушка ≈ 7.2 кг

# Итоговый остаток
итоговый_остаток = фактический_приход - усушка
# итоговый_остаток ≈ 97.8 кг
```

#### 4.4 Пример расчета с разными излишками для разных номенклатур
```python
# Настройка излишков для разных номенклатур
model.set_surplus_rate(0.05, "СКУМБРИЯ ХК")  # 5% излишка
model.set_surplus_rate(0.10, "СЕЛЬДЬ ХК")    # 10% излишка
model.set_surplus_rate(0.03, "ОКУНЬ ХК")     # 3% излишка

# Расчет для скумбрии
mackerel_shrinkage = model.predict_with_adaptation(
    t=7, 
    initial_balance=100.0, 
    nomenclature="СКУМБРИЯ ХК"
)

# Расчет для сельди
herring_shrinkage = model.predict_with_adaptation(
    t=7, 
    initial_balance=100.0, 
    nomenclature="СЕЛЬДЬ ХК"
)

# Расчет для окуня
perch_shrinkage = model.predict_with_adaptation(
    t=7, 
    initial_balance=100.0, 
    nomenclature="ОКУНЬ ХК"
)
```

### 5. СБОР ВРЕМЕННЫХ РЯДОВ

#### 5.1 Хронология событий
- Начальная дата партии: 02.07.2025 11:30:00
- Период наблюдения: 15.07.2025 - 21.07.2025 (7 дней)

#### 5.2 Расчет дней хранения
Относительно начальной даты партии (02.07.2025):
- 15.07.2025: t = 13 дней
- 16.07.2025: t = 14 дней
- 17.07.2025: t = 15 дней
- 18.07.2025: t = 16 дней
- 19.07.2025: t = 17 дней
- 20.07.2025: t = 18 дней
- 21.07.2025: t = 19 дней

#### 5.3 Формирование временного ряда остатков
| День (t) | Дата        | Остаток (кг) |
|----------|-------------|--------------|
| 0        | 02.07.2025  | 13.428       |
| 13       | 15.07.2025  | 13.164       |
| 14       | 16.07.2025  | 12.988       |
| 15       | 17.07.2025  | 12.788       |
| 16       | 18.07.2025  | 12.634       |
| 17       | 19.07.2025  | 12.526       |
| 18       | 20.07.2025  | 12.236       |
| 19       | 21.07.2025  | 12.000       |

#### 5.4 Расчет накопленной усушки
Используем формулу: S(t) = начальный_остаток - текущий_остаток

| День (t) | Остаток (кг) | Усушка S(t) (кг) |
|----------|--------------|------------------|
| 0        | 13.428       | 0.000            |
| 13       | 13.164       | 0.264            |
| 14       | 12.988       | 0.440            |
| 15       | 12.788       | 0.640            |
| 16       | 12.634       | 0.794            |
| 17       | 12.526       | 0.902            |
| 18       | 12.236       | 1.192            |
| 19       | 12.000       | 1.428            |

### 6. МАТЕМАТИЧЕСКАЯ МОДЕЛЬ

#### 6.1 Экспоненциальная модель усушки
````
S(t) = a × (1 - e^(-b×t)) + c
```

Где:
- S(t) - усушка в кг через t дней
- a - максимальная усушка (асимптотическое значение)
- b - скорость усушки (коэффициент скорости, день⁻¹)
- c - базовая усушка (начальная усушка)
- t - время в днях

#### 6.2 Физические ограничения
- a > 0 (максимальная усушка положительна)
- b > 0 (скорость усушки положительна)
- c ≥ 0 (базовая усушка неотрицательна)

### 7. ОПТИМИЗАЦИЯ КОЭФФИЦИЕНТОВ

#### 7.1 Метод оптимизации
Используется нелинейная регрессия методом наименьших квадратов:
````
minimize Σ [S_наблюдаемое(t) - S_модель(t)]²
```