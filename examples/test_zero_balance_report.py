#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –æ—Ç—á–µ—Ç–∞ –æ –Ω—É–ª–µ–≤—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö.
"""

import sys
import os
import pandas as pd
import logging
from io import StringIO

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ src –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../src')))

from core.shrinkage_system import ShrinkageSystem


def test_zero_balance_report():
    """–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã –æ—Ç—á–µ—Ç–∞ –æ –Ω—É–ª–µ–≤—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö."""
    print("üîç –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –æ—Ç—á–µ—Ç–∞ –æ –Ω—É–ª–µ–≤—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º—É —É—Å—É—à–∫–∏
    system = ShrinkageSystem()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –Ω—É–ª–µ–≤—ã–º–∏ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏
    test_data = pd.DataFrame([
        {
            '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞': '–ë–´–ß–ö–ò –í–Ø–õ–ï–ù–´–ï',
            '–ù–∞—á–∞–ª—å–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': 0.844,  # –ù–µ–Ω—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫
            '–ü—Ä–∏—Ö–æ–¥': 1.25,
            '–†–∞—Å—Ö–æ–¥': 0.702,
            '–ö–æ–Ω–µ—á–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': 1.392,
            '–ü–µ—Ä–∏–æ–¥_—Ö—Ä–∞–Ω–µ–Ω–∏—è_–¥–Ω–µ–π': 7
        },
        {
            '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞': '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 1',
            '–ù–∞—á–∞–ª—å–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': None,  # –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            '–ü—Ä–∏—Ö–æ–¥': 2.0,
            '–†–∞—Å—Ö–æ–¥': 1.5,
            '–ö–æ–Ω–µ—á–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': 0.5,
            '–ü–µ—Ä–∏–æ–¥_—Ö—Ä–∞–Ω–µ–Ω–∏—è_–¥–Ω–µ–π': 7
        },
        {
            '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞': '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 2',
            '–ù–∞—á–∞–ª—å–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': 0.0,  # –ù—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫
            '–ü—Ä–∏—Ö–æ–¥': 3.0,
            '–†–∞—Å—Ö–æ–¥': 2.0,
            '–ö–æ–Ω–µ—á–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': 1.0,
            '–ü–µ—Ä–∏–æ–¥_—Ö—Ä–∞–Ω–µ–Ω–∏—è_–¥–Ω–µ–π': 7
        },
        {
            '–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞': '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 3',
            '–ù–∞—á–∞–ª—å–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': None,  # –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            '–ü—Ä–∏—Ö–æ–¥': 1.0,
            '–†–∞—Å—Ö–æ–¥': 0.5,
            '–ö–æ–Ω–µ—á–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫': None,  # –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
            '–ü–µ—Ä–∏–æ–¥_—Ö—Ä–∞–Ω–µ–Ω–∏—è_–¥–Ω–µ–π': 7
        }
    ])
    
    print("üìã –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:")
    print(test_data.to_string(index=False))
    
    print("\nüìã –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π...")
    print("   (–í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –æ—Ç—á–µ—Ç –æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞—Ö —Å –Ω—É–ª–µ–≤—ã–º–∏ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏)")
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ª–æ–≥–æ–≤
    # (–õ–æ–≥–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏)
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    results = system._check_inventory_availability(test_data, "—Ç–µ—Å—Ç–æ–≤—ã–π_—Ñ–∞–π–ª.xlsx")
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–≥–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏
    pass
    
    print("\nüìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:")
    print(results.to_string(index=False))
    
    # –û—Ç—á–µ—Ç –æ –Ω—É–ª–µ–≤—ã—Ö –æ—Å—Ç–∞—Ç–∫–∞—Ö –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö –∫–æ–Ω—Å–æ–ª–∏
    print("\n‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞—Ö —Å –Ω—É–ª–µ–≤—ã–º–∏ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ 0.0
    missing_initial_count = 0
    for idx, row in results.iterrows():
        if row['–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞'] in ['–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 1', '–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç 3']:
            if row['–ù–∞—á–∞–ª—å–Ω—ã–π_–æ—Å—Ç–∞—Ç–æ–∫'] == 0.0:
                missing_initial_count += 1
    
    if missing_initial_count == 2:
        print("‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ 0.0")
    else:
        print("‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –±—ã–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
    
    print("\nüìù –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞—Ö —Å –Ω—É–ª–µ–≤—ã–º–∏ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏")
    print("   –≠—Ç–æ —á–∞—Å—Ç—å –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")


if __name__ == "__main__":
    test_zero_balance_report()